<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Instagram Post Organizer</title>
    <!-- Tailwind CSS CDN -->
    <script src="https://cdn.tailwindcss.com"></script>

    <!-- QR code scanner library -->
    <script src="https://unpkg.com/html5-qrcode" type="text/javascript"></script>
</head>
<!-- Supabase JS CDN -->
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
</head>

<body>
    <div class="max-w-4xl mx-auto p-4">
        <header id="mainHeader" class="flex flex-col sm:flex-row items-center justify-between mb-6">
            <h1 class="text-3xl font-bold mb-2 sm:mb-0">Instagram Post Organizer</h1>
            <button id="addPostBtn"
                class="bg-blue-600 hover:bg-blue-700 text-white font-semibold py-2 px-4 rounded shadow">Add New
                Post</button>
        </header>

        <div class="overflow-x-auto bg-white rounded-lg shadow mb-8">
            <table class="min-w-full divide-y divide-gray-200">
                <thead class="bg-gray-100">
                    <tr>
                        <th class="px-4 py-2 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">ID
                        </th>
                        <th class="px-4 py-2 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Image
                        </th>
                        <th class="px-4 py-2 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Post
                            Description</th>
                        <th class="px-4 py-2 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                            Status</th>
                        <th class="px-4 py-2 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                            Actions</th>
                    </tr>
                </thead>
                <tbody id="postsTableBody" class="bg-white divide-y divide-gray-200">
                    <!-- Posts will be dynamically added here -->
                </tbody>
            </table>
        </div>

        <!-- Add/Edit Post Modal -->
        <div id="postModal" class="fixed inset-0 z-50 flex items-center justify-center bg-black bg-opacity-50 hidden">
            <div class="bg-white rounded-lg shadow-lg w-full max-w-lg p-6 relative">
                <span id="modalClose"
                    class="absolute top-4 right-4 text-2xl text-gray-400 hover:text-gray-700 cursor-pointer">&times;</span>
                <h2 id="modalTitle" class="text-xl font-semibold mb-4">Add New Post</h2>
                <form id="postForm" class="space-y-4">
                    <input type="hidden" id="postId">
                    <div class="mb-4">
                        <label for="postImages" class="block text-sm font-medium text-gray-700 mb-1">Post
                            Images:</label>
                        <input type="file" id="postImages" accept="image/*" multiple
                            class="block w-full text-sm text-gray-500 file:mr-4 file:py-2 file:px-4 file:rounded file:border-0 file:text-sm file:font-semibold file:bg-blue-50 file:text-blue-700 hover:file:bg-blue-100">
                        <div id="imagePreview" class="flex flex-wrap gap-2 mt-2"></div>
                    </div>
                    <div class="mb-4">
                        <label for="postDescription" class="block text-sm font-medium text-gray-700 mb-1">Post
                            Description:</label>
                        <textarea id="postDescription" rows="4" required
                            placeholder="Enter your Instagram post description..."
                            class="block w-full border border-gray-300 rounded p-2 focus:ring-blue-500 focus:border-blue-500"></textarea>
                    </div>
                    <div class="mb-4">
                        <label for="postStatus" class="block text-sm font-medium text-gray-700 mb-1">Status:</label>
                        <select id="postStatus"
                            class="block w-full border border-gray-300 rounded p-2 focus:ring-blue-500 focus:border-blue-500">
                            <option value="pending">Pending</option>
                            <option value="approved">Approved</option>
                            <option value="rejected">Rejected</option>
                        </select>
                    </div>
                    <div class="flex justify-end gap-2">
                        <button type="submit"
                            class="bg-blue-600 hover:bg-blue-700 text-white font-semibold py-2 px-4 rounded shadow">Save
                            Post</button>
                        <button type="button"
                            class="bg-gray-200 hover:bg-gray-300 text-gray-700 font-semibold py-2 px-4 rounded shadow"
                            onclick="closeModal()">Cancel</button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <script>

        // Show QR modal for creds if not present in localStorage
        function ensureCredsWithQR(onReady) {
    if (localStorage.getItem('creds')) {
        onReady();
        return;
    }

    // Create modal with enhanced styling
    const modal = document.createElement('div');
    modal.id = 'qr-creds-modal';
    modal.style.cssText = `
        position: fixed;
        top: 0;
        left: 0;
        width: 100vw;
        height: 100vh;
        background: rgba(0, 0, 0, 0.6);
        backdrop-filter: blur(8px);
        display: flex;
        align-items: center;
        justify-content: center;
        z-index: 99999;
        opacity: 0;
        transition: opacity 0.3s ease;
        font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
    `;

    const box = document.createElement('div');
    box.style.cssText = `
        background: linear-gradient(135deg, #ffffff 0%, #f8fafc 100%);
        padding: 2.5em 2em;
        border-radius: 20px;
        box-shadow: 0 20px 40px rgba(0, 0, 0, 0.15), 0 0 0 1px rgba(255, 255, 255, 0.1);
        min-width: 380px;
        max-width: 90vw;
        text-align: center;
        transform: scale(0.9) translateY(20px);
        transition: transform 0.3s ease;
        position: relative;
        overflow: hidden;
    `;

    // Add subtle animated background pattern
    const bgPattern = document.createElement('div');
    bgPattern.style.cssText = `
        position: absolute;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        opacity: 0.03;
        background-image: 
            radial-gradient(circle at 25px 25px, #4f46e5 2px, transparent 2px),
            radial-gradient(circle at 75px 75px, #06b6d4 2px, transparent 2px);
        background-size: 100px 100px;
        pointer-events: none;
    `;

    const title = document.createElement('h2');
    title.textContent = 'Scan QR Code for Credentials';
    title.style.cssText = `
        margin: 0 0 0.5em 0;
        font-weight: 700;
        font-size: 1.5em;
        background: linear-gradient(135deg, #1e293b, #475569);
        -webkit-background-clip: text;
        -webkit-text-fill-color: transparent;
        background-clip: text;
        color: #1e293b;
    `;

    const subtitle = document.createElement('p');
    subtitle.textContent = 'Use your camera or upload an image to authenticate';
    subtitle.style.cssText = `
        margin: 0 0 1.5em 0;
        color: #64748b;
        font-size: 0.95em;
        line-height: 1.4;
    `;

    const errorMsg = document.createElement('div');
    errorMsg.style.cssText = `
        color: #dc2626;
        background: #fef2f2;
        border: 1px solid #fecaca;
        border-radius: 8px;
        padding: 0.75em 1em;
        margin: 1em 0;
        font-size: 0.9em;
        display: none;
        animation: shake 0.5s ease-in-out;
    `;

    // Add shake animation for errors
    const style = document.createElement('style');
    style.textContent = `
        @keyframes shake {
            0%, 100% { transform: translateX(0); }
            25% { transform: translateX(-5px); }
            75% { transform: translateX(5px); }
        }
        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.7; }
        }
        .scanning-indicator {
            animation: pulse 2s infinite;
        }
    `;
    document.head.appendChild(style);

    // QR scanner container with improved styling
    const qrContainer = document.createElement('div');
    qrContainer.id = 'qr-reader';
    qrContainer.style.cssText = `
        margin: 1.5em auto;
        width: 280px;
        height: 280px;
        border-radius: 16px;
        overflow: hidden;
        box-shadow: 0 8px 20px rgba(0, 0, 0, 0.1);
        border: 3px solid #e2e8f0;
        background: #f8fafc;
        position: relative;
        display: flex;
        align-items: center;
        justify-content: center;
    `;

    // Placeholder content for QR container
    const qrPlaceholder = document.createElement('div');
    qrPlaceholder.style.cssText = `
        color: #94a3b8;
        font-size: 0.9em;
        text-align: center;
        padding: 2em;
        line-height: 1.5;
    `;
    qrPlaceholder.innerHTML = `
        <div style="font-size: 3em; margin-bottom: 0.5em;">📷</div>
        <div>Camera will appear here</div>
    `;
    qrContainer.appendChild(qrPlaceholder);

    // Enhanced buttons
    const buttonContainer = document.createElement('div');
    buttonContainer.style.cssText = `
        display: flex;
        gap: 1em;
        justify-content: center;
        flex-wrap: wrap;
        margin-top: 1.5em;
    `;

    const webcamBtn = document.createElement('button');
    webcamBtn.innerHTML = `
        <span style="margin-right: 0.5em;">📹</span>
        Scan with Camera
    `;
    webcamBtn.style.cssText = `
        background: linear-gradient(135deg, #4f46e5, #7c3aed);
        color: white;
        border: none;
        padding: 0.875em 1.5em;
        border-radius: 12px;
        font-size: 0.95em;
        font-weight: 600;
        cursor: pointer;
        transition: all 0.2s ease;
        box-shadow: 0 4px 12px rgba(79, 70, 229, 0.3);
        min-width: 140px;
    `;

    const uploadBtn = document.createElement('button');
    uploadBtn.innerHTML = `
        <span style="margin-right: 0.5em;">📁</span>
        Upload Image
    `;
    uploadBtn.style.cssText = `
        background: white;
        color: #475569;
        border: 2px solid #e2e8f0;
        padding: 0.875em 1.5em;
        border-radius: 12px;
        font-size: 0.95em;
        font-weight: 600;
        cursor: pointer;
        transition: all 0.2s ease;
        min-width: 140px;
    `;

    // Add hover effects
    webcamBtn.onmouseenter = () => {
        webcamBtn.style.transform = 'translateY(-2px)';
        webcamBtn.style.boxShadow = '0 6px 16px rgba(79, 70, 229, 0.4)';
    };
    webcamBtn.onmouseleave = () => {
        webcamBtn.style.transform = 'translateY(0)';
        webcamBtn.style.boxShadow = '0 4px 12px rgba(79, 70, 229, 0.3)';
    };

    uploadBtn.onmouseenter = () => {
        uploadBtn.style.transform = 'translateY(-2px)';
        uploadBtn.style.borderColor = '#cbd5e1';
        uploadBtn.style.boxShadow = '0 4px 12px rgba(0, 0, 0, 0.1)';
    };
    uploadBtn.onmouseleave = () => {
        uploadBtn.style.transform = 'translateY(0)';
        uploadBtn.style.borderColor = '#e2e8f0';
        uploadBtn.style.boxShadow = 'none';
    };

    const fileInput = document.createElement('input');
    fileInput.type = 'file';
    fileInput.accept = 'image/*';
    fileInput.style.display = 'none';

    // Status indicator
    const statusIndicator = document.createElement('div');
    statusIndicator.style.cssText = `
        margin-top: 1em;
        padding: 0.5em 1em;
        border-radius: 20px;
        font-size: 0.85em;
        font-weight: 500;
        display: none;
    `;

    let html5QrCode = null;
    let scanning = false;

    function showStatus(message, type = 'info') {
        statusIndicator.textContent = message;
        statusIndicator.style.display = 'block';
        
        if (type === 'scanning') {
            statusIndicator.style.cssText += `
                background: #dbeafe;
                color: #1e40af;
                display: block;
            `;
            statusIndicator.classList.add('scanning-indicator');
        } else if (type === 'success') {
            statusIndicator.style.cssText += `
                background: #dcfce7;
                color: #166534;
                display: block;
            `;
            statusIndicator.classList.remove('scanning-indicator');
        }
    }

    function hideStatus() {
        statusIndicator.style.display = 'none';
        statusIndicator.classList.remove('scanning-indicator');
    }

    function handleDecoded(decodedText) {
        try {
            const credsObj = JSON.parse(decodedText);
            showStatus('✅ Credentials verified successfully!', 'success');
            
            setTimeout(() => {
                localStorage.setItem('creds', JSON.stringify(credsObj));
                modal.style.opacity = '0';
                box.style.transform = 'scale(0.9) translateY(20px)';
                
                setTimeout(() => {
                    document.body.removeChild(modal);
                    onReady();
                }, 300);
            }, 800);
        } catch (e) {
            errorMsg.textContent = '❌ Invalid QR code: Please ensure it contains valid credential data.';
            errorMsg.style.display = 'block';
            hideStatus();
        }
    }

    webcamBtn.onclick = () => {
        errorMsg.style.display = 'none';
        hideStatus();
        
        if (html5QrCode) {
            html5QrCode.stop().then(() => {
                html5QrCode.clear();
                startWebcam();
            });
        } else {
            startWebcam();
        }
    };

    function startWebcam() {
        qrContainer.innerHTML = '';
        showStatus('📷 Starting camera...', 'scanning');
        
        html5QrCode = new Html5Qrcode('qr-reader');
        scanning = true;
        
        html5QrCode.start(
            { facingMode: 'environment' },
            { fps: 10, qrbox: { width: 240, height: 240 } },
            (decodedText) => {
                if (scanning) {
                    scanning = false;
                    html5QrCode.stop().then(() => html5QrCode.clear());
                    handleDecoded(decodedText);
                }
            },
            (errorMessage) => {
                // Ignore scan errors - they're expected during scanning
            }
        ).then(() => {
            showStatus('🔍 Point camera at QR code', 'scanning');
        }).catch((err) => {
            errorMsg.textContent = '❌ Camera access denied or unavailable. Please check permissions.';
            errorMsg.style.display = 'block';
            hideStatus();
            
            // Restore placeholder
            qrContainer.appendChild(qrPlaceholder);
        });
    }

    uploadBtn.onclick = () => {
        errorMsg.style.display = 'none';
        hideStatus();
        fileInput.value = '';
        fileInput.click();
    };

    fileInput.onchange = (e) => {
        if (!e.target.files.length) return;
        
        const imageFile = e.target.files[0];
        showStatus('🔍 Processing image...', 'scanning');
        
        if (html5QrCode) {
            html5QrCode.clear();
        } else {
            html5QrCode = new Html5Qrcode('qr-reader');
        }
        
        scanning = false;
        html5QrCode.scanFile(imageFile, true)
            .then(decodedText => {
                handleDecoded(decodedText);
            })
            .catch(err => {
                errorMsg.textContent = '❌ No QR code found in image. Please try a clearer image.';
                errorMsg.style.display = 'block';
                hideStatus();
            });
    };

    // Assembly
    box.appendChild(bgPattern);
    box.appendChild(title);
    box.appendChild(subtitle);
    box.appendChild(qrContainer);
    box.appendChild(errorMsg);
    box.appendChild(buttonContainer);
    buttonContainer.appendChild(webcamBtn);
    buttonContainer.appendChild(uploadBtn);
    box.appendChild(fileInput);
    box.appendChild(statusIndicator);
    modal.appendChild(box);
    document.body.appendChild(modal);

    // Animate in
    requestAnimationFrame(() => {
        modal.style.opacity = '1';
        box.style.transform = 'scale(1) translateY(0)';
    });
}
        // Load credentials from localStorage
        function getCreds() {
            const credsStr = localStorage.getItem('creds');
            if (!credsStr) throw new Error('Missing credentials in localStorage under key "creds"');
            try {
                return JSON.parse(credsStr);
            } catch (e) {
                throw new Error('Invalid JSON in creds localStorage');
            }
        }

        function initApp() {
            const creds = getCreds();
            window.creds = creds;
            const SUPABASE_URL = creds.supabase.url;
            const SUPABASE_KEY = creds.supabase.key;
            window.supabase = window.supabase || {};
            window.supabaseClient = window.supabase.createClient(SUPABASE_URL, SUPABASE_KEY);
            // ...existing code...
            window.organizer = new PostOrganizer();
        }

        // Instagram Post Organizer JavaScript with Multiple Image Support

        // Patch: Use window.supabaseClient instead of supabase
        class PostOrganizer {
            constructor() {
                this.posts = [];
                this.currentImages = [];
                this.currentPage = 1;
                this.pageSize = 10;
                this.totalPosts = 0;
                this.init();
            }

            async init() {
                this.bindEvents();
                await this.loadPosts();
                this.renderPosts();
            }

            bindEvents() {
                document.getElementById('addPostBtn').addEventListener('click', () => this.openModal());
                document.getElementById('modalClose').addEventListener('click', () => this.closeModal());
                window.addEventListener('click', (e) => {
                    if (e.target === document.getElementById('postModal')) {
                        this.closeModal();
                    }
                });
                document.getElementById('postForm').addEventListener('submit', (e) => this.handleFormSubmit(e));
                document.getElementById('postImages').addEventListener('change', (e) => this.handleMultipleImageUpload(e));
                // Pagination controls
                document.addEventListener('click', (e) => {
                    if (e.target && e.target.id === 'prevPageBtn') {
                        this.prevPage();
                    }
                    if (e.target && e.target.id === 'nextPageBtn') {
                        this.nextPage();
                    }
                });
            }

            async loadPosts() {
                // Get total count for pagination
                const { count, error: countError } = await window.supabaseClient
                    .from('posts')
                    .select('*', { count: 'exact', head: true });
                if (countError) {
                    this.totalPosts = 0;
                } else {
                    this.totalPosts = count || 0;
                }
                // Calculate range for current page
                const from = (this.currentPage - 1) * this.pageSize;
                const to = from + this.pageSize - 1;
                // Fetch paginated posts
                const { data, error } = await window.supabaseClient
                    .from('posts')
                    .select('*')
                    .order('id', { ascending: true })
                    .range(from, to);
                if (error) {
                    alert('Failed to load posts from Supabase.');
                    this.posts = [];
                } else {
                    this.posts = data || [];
                }
            }
            prevPage() {
                if (this.currentPage > 1) {
                    this.currentPage--;
                    this.loadPosts().then(() => this.renderPosts());
                }
            }

            nextPage() {
                const maxPage = Math.ceil(this.totalPosts / this.pageSize);
                if (this.currentPage < maxPage) {
                    this.currentPage++;
                    this.loadPosts().then(() => this.renderPosts());
                }
            }

            async handleMultipleImageUpload(e) {
                const files = Array.from(e.target.files);
                const previewContainer = document.getElementById('imagePreview');
                for (const file of files) {
                    if (file && file.type.startsWith('image/')) {
                        // Show uploading placeholder
                        this.currentImages.push({ uploading: true });
                        this.renderImagePreview();
                        try {
                            const url = await this.uploadToImgBB(file);
                            // Replace the placeholder with the real URL
                            const idx = this.currentImages.findIndex(img => img.uploading);
                            if (idx !== -1) {
                                this.currentImages[idx] = url;
                            }
                        } catch (err) {
                            alert('Failed to upload image to ImgBB.');
                            // Remove the placeholder
                            const idx = this.currentImages.findIndex(img => img.uploading);
                            if (idx !== -1) {
                                this.currentImages.splice(idx, 1);
                            }
                        }
                        this.renderImagePreview();
                    }
                }
                // Clear the file input to allow re-uploading the same files
                e.target.value = '';
            }

            async uploadToImgBB(file) {
                const apiKey = creds.imgbb.apiKey;
                const formData = new FormData();
                formData.append('key', apiKey);
                formData.append('image', file);
                const response = await fetch('https://api.imgbb.com/1/upload', {
                    method: 'POST',
                    body: formData
                });
                const data = await response.json();
                if (data && data.success && data.data && data.data.url) {
                    return data.data.url;
                } else {
                    throw new Error('ImgBB upload failed');
                }
            }

            renderImagePreview() {
                const previewContainer = document.getElementById('imagePreview');
                previewContainer.innerHTML = '';
                this.currentImages.forEach((imageData, index) => {
                    const previewItem = document.createElement('div');
                    previewItem.className = 'relative inline-block mr-2 mb-2';
                    if (typeof imageData === 'string') {
                        previewItem.innerHTML = `
                    <img src="${imageData}" alt="Preview ${index + 1}" class="w-20 h-20 object-cover rounded border border-gray-200 shadow-sm">
                    <button type="button" class="absolute top-0 right-0 bg-white bg-opacity-80 text-gray-700 rounded-full w-6 h-6 flex items-center justify-center text-lg font-bold shadow hover:bg-red-100" style="transform: translate(40%,-40%);" onclick="organizer.removeImage(${index})">×</button>
                `;
                    } else if (imageData.uploading) {
                        previewItem.innerHTML = `
                    <div class="w-20 h-20 flex items-center justify-center bg-gray-100 text-gray-400 rounded border border-gray-200">Uploading...</div>
                `;
                    }
                    previewContainer.appendChild(previewItem);
                });
            }

            removeImage(index) {
                this.currentImages.splice(index, 1);
                this.renderImagePreview();
            }

            openModal(post = null) {
                const modal = document.getElementById('postModal');
                const form = document.getElementById('postForm');
                const title = document.getElementById('modalTitle');

                if (post) {
                    title.textContent = 'Edit Post';
                    document.getElementById('postId').value = post.id;
                    document.getElementById('postDescription').value = post.description;
                    document.getElementById('postStatus').value = post.status;

                    // Load existing images
                    this.currentImages = post.images || [];
                    this.renderImagePreview();
                } else {
                    title.textContent = 'Add New Post';
                    form.reset();
                    document.getElementById('postId').value = '';
                    this.currentImages = [];
                    this.renderImagePreview();
                }

                modal.classList.remove('hidden');
            }

            closeModal() {
                const modal = document.getElementById('postModal');
                modal.classList.add('hidden');
                document.getElementById('postForm').reset();
                this.currentImages = [];
                document.getElementById('imagePreview').innerHTML = '';
            }


            async handleFormSubmit(e) {
                e.preventDefault();
                const id = document.getElementById('postId').value;
                const description = document.getElementById('postDescription').value.trim();
                const status = document.getElementById('postStatus').value;
                if (!description) {
                    alert('Please enter a post description');
                    return;
                }
                if (id) {
                    // Edit existing post in Supabase
                    const { error } = await window.supabaseClient
                        .from('posts')
                        .update({
                            description,
                            status,
                            images: this.currentImages,
                            updated_at: new Date().toISOString()
                        })
                        .eq('id', parseInt(id));
                    if (error) {
                        alert('Failed to update post in Supabase.');
                        return;
                    }
                    // Update local array instead of reloading all posts
                    const post = this.posts.find(p => p.id === parseInt(id));
                    if (post) {
                        post.description = description;
                        post.status = status;
                        post.images = this.currentImages;
                        post.updated_at = new Date().toISOString();
                    }
                } else {
                    // Add new post to Supabase - get the created post back
                    const { data, error } = await window.supabaseClient
                        .from('posts')
                        .insert({
                            description,
                            status,
                            images: this.currentImages,
                            created_at: new Date().toISOString(),
                            updated_at: new Date().toISOString()
                        })
                        .select();
                    if (error) {
                        alert('Failed to add post to Supabase.');
                        return;
                    }
                    // Add to local array instead of reloading all posts
                    if (data && data[0]) {
                        this.posts.push(data[0]);
                        this.totalPosts++;
                    }
                }
                this.renderPosts();
                this.closeModal();
            }


            editPost(id) {
                const post = this.posts.find(p => p.id === id);
                if (post) {
                    this.openModal(post);
                }
            }


            async deletePost(id) {
                if (confirm('Are you sure you want to delete this post?')) {
                    const { error } = await window.supabaseClient
                        .from('posts')
                        .delete()
                        .eq('id', id);
                    if (error) {
                        alert('Failed to delete post from Supabase.');
                        return;
                    }
                    // Remove from local array instead of reloading all posts
                    this.posts = this.posts.filter(post => post.id !== id);
                    this.totalPosts--;
                    this.renderPosts();
                }
            }


            async toggleStatus(id, newStatus) {
                const { error } = await window.supabaseClient
                    .from('posts')
                    .update({
                        status: newStatus,
                        updated_at: new Date().toISOString()
                    })
                    .eq('id', id);
                if (error) {
                    alert('Failed to update status in Supabase.');
                    return;
                }
                // Update local array instead of reloading all posts
                const post = this.posts.find(p => p.id === id);
                if (post) {
                    post.status = newStatus;
                    post.updated_at = new Date().toISOString();
                }
                this.renderPosts();
            }


            renderPosts() {
                const tbody = document.getElementById('postsTableBody');
                tbody.innerHTML = '';
                if (this.posts.length === 0) {
                    tbody.innerHTML = `
                <tr>
                    <td colspan="5" class="empty-state">
                        <h3>No posts yet</h3>
                        <p>Click \"Add New Post\" to get started</p>
                    </td>
                </tr>
            `;
                } else {
                    this.posts.forEach(post => {
                        const row = document.createElement('tr');
                        let imagesHtml = '<span class="text-gray-400">No images</span>';
                        if (post.images && post.images.length > 0) {
                            const displayCount = Math.min(4, post.images.length);
                            imagesHtml = '<div class="flex flex-wrap gap-1 items-center">';
                            for (let i = 0; i < displayCount; i++) {
                                imagesHtml += `<img src="${post.images[i]}" alt="Image ${i + 1}" class="w-16 h-16 object-cover rounded border border-gray-200">`;
                            }
                            if (post.images.length > 4) {
                                imagesHtml += `<div class="ml-2 text-xs text-gray-500 font-semibold">+${post.images.length - 4} more</div>`;
                            }
                            imagesHtml += '</div>';
                        }
                        // Beautified action buttons with icons and spacing
                        row.innerHTML = `
                    <td>${post.id}</td>
                    <td class="post-images-cell">${imagesHtml}</td>
                    <td class="post-description">${post.description}</td>
                    <td>
                        <span class="status-badge ${post.status}">${post.status}</span>
                    </td>
                    <td class="actions">
                        <div class="flex gap-2">
                            <button class="inline-flex items-center gap-1 px-3 py-1 rounded bg-blue-500 hover:bg-blue-600 text-white text-xs font-semibold shadow transition" title="Edit" onclick="organizer.editPost(${post.id})">
                                <svg xmlns='http://www.w3.org/2000/svg' class='h-4 w-4' fill='none' viewBox='0 0 24 24' stroke='currentColor'><path stroke-linecap='round' stroke-linejoin='round' stroke-width='2' d='M15.232 5.232l3.536 3.536M9 13l6.536-6.536a2 2 0 112.828 2.828L11.828 15.828a2 2 0 01-2.828 0L5 11.828a2 2 0 010-2.828L9 13z' /></svg>
                                Edit
                            </button>
                            <button class="inline-flex items-center gap-1 px-3 py-1 rounded ${post.status === 'approved' ? 'bg-yellow-400 hover:bg-yellow-500 text-gray-900' : 'bg-green-500 hover:bg-green-600 text-white'} text-xs font-semibold shadow transition" title="${post.status === 'approved' ? 'Unapprove' : 'Approve'}" onclick="organizer.toggleStatus(${post.id}, '${post.status === 'approved' ? 'pending' : 'approved'}')">
                                ${post.status === 'approved'
                                ? `<svg xmlns='http://www.w3.org/2000/svg' class='h-4 w-4' fill='none' viewBox='0 0 24 24' stroke='currentColor'><path stroke-linecap='round' stroke-linejoin='round' stroke-width='2' d='M6 18L18 6M6 6l12 12' /></svg>Unapprove`
                                : `<svg xmlns='http://www.w3.org/2000/svg' class='h-4 w-4' fill='none' viewBox='0 0 24 24' stroke='currentColor'><path stroke-linecap='round' stroke-linejoin='round' stroke-width='2' d='M5 13l4 4L19 7' /></svg>Approve`
                            }
                            </button>
                            <button class="inline-flex items-center gap-1 px-3 py-1 rounded bg-red-500 hover:bg-red-600 text-white text-xs font-semibold shadow transition" title="Delete" onclick="organizer.deletePost(${post.id})">
                                <svg xmlns='http://www.w3.org/2000/svg' class='h-4 w-4' fill='none' viewBox='0 0 24 24' stroke='currentColor'><path stroke-linecap='round' stroke-linejoin='round' stroke-width='2' d='M6 18L18 6M6 6l12 12' /></svg>
                                Delete
                            </button>
                        </div>
                    </td>
                `;
                        tbody.appendChild(row);
                    });
                }
                // Pagination controls
                const maxPage = Math.max(1, Math.ceil(this.totalPosts / this.pageSize));
                const paginationRow = document.createElement('tr');
                paginationRow.innerHTML = `
            <td colspan="5" class="py-2 text-center">
                <button id="prevPageBtn" class="btn small" ${this.currentPage === 1 ? 'disabled' : ''}>Prev</button>
                <span class="mx-2">Page ${this.currentPage} of ${maxPage}</span>
                <button id="nextPageBtn" class="btn small" ${this.currentPage === maxPage ? 'disabled' : ''}>Next</button>
            </td>
        `;
                tbody.appendChild(paginationRow);
            }


            // Export functionality
            async exportPosts() {
                // Fetch all posts from Supabase and export as JSON
                const { data, error } = await window.supabaseClient
                    .from('posts')
                    .select('*')
                    .order('id', { ascending: true });
                if (error) {
                    alert('Failed to export posts from Supabase.');
                    return;
                }
                const dataStr = JSON.stringify(data, null, 2);
                const dataBlob = new Blob([dataStr], { type: 'application/json' });
                const url = URL.createObjectURL(dataBlob);
                const link = document.createElement('a');
                link.href = url;
                link.download = 'instagram-posts.json';
                link.click();
            }

            // Import functionality
            async importPosts(file) {
                const reader = new FileReader();
                reader.onload = async (e) => {
                    try {
                        const importedPosts = JSON.parse(e.target.result);
                        if (Array.isArray(importedPosts)) {
                            // Remove id/created_at/updated_at to avoid conflicts
                            const cleanPosts = importedPosts.map(p => ({
                                description: p.description,
                                status: p.status,
                                images: p.images || [],
                                created_at: new Date().toISOString(),
                                updated_at: new Date().toISOString()
                            }));
                            const { error } = await window.supabaseClient
                                .from('posts')
                                .insert(cleanPosts);
                            if (error) {
                                alert('Failed to import posts to Supabase.');
                                return;
                            }
                            await this.loadPosts();
                            this.renderPosts();
                            alert('Posts imported successfully!');
                        }
                    } catch (error) {
                        alert('Error importing posts. Please check the file format.');
                    }
                };
                reader.readAsText(file);
            }
        }


        // Initialize the app only after creds are set
        ensureCredsWithQR(initApp);

        // Add export/import buttons
        document.addEventListener('DOMContentLoaded', () => {
            const header = document.getElementById('mainHeader');
            // Create export button
            const exportBtn = document.createElement('button');
            exportBtn.textContent = 'Export Posts';
            exportBtn.className = 'btn secondary';
            exportBtn.onclick = () => organizer.exportPosts();
            // Create import button
            const importBtn = document.createElement('button');
            importBtn.textContent = 'Import Posts';
            importBtn.className = 'btn secondary';
            // Create hidden file input
            const fileInput = document.createElement('input');
            fileInput.type = 'file';
            fileInput.accept = '.json';
            fileInput.style.display = 'none';
            fileInput.onchange = (e) => {
                if (e.target.files[0]) {
                    organizer.importPosts(e.target.files[0]);
                }
            };
            importBtn.onclick = () => fileInput.click();
            // Add buttons to header
            header.appendChild(exportBtn);
            header.appendChild(importBtn);
            header.appendChild(fileInput);
        });

        // Keyboard shortcuts
        document.addEventListener('keydown', (e) => {
            if (e.ctrlKey && e.key === 'n') {
                e.preventDefault();
                organizer.openModal();
            }
            if (e.key === 'Escape') {
                organizer.closeModal();
            }
        });

    </script>
</body>

</html>

<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Instagram Post Organizer - Vue.js</title>

    <!-- Tailwind CSS CDN -->
    <script src="https://cdn.tailwindcss.com"></script>

    <!-- Vue 3 CDN -->
    <script src="https://unpkg.com/vue@3/dist/vue.global.js"></script>

    <!-- QR code scanner library -->
    <script src="https://unpkg.com/html5-qrcode" type="text/javascript"></script>

    <!-- Supabase JS CDN -->
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

    <style>
        /* Custom styles */
        .status-badge {
            @apply px-3 py-1 rounded-full text-xs font-semibold;
        }
        .status-badge.pending {
            @apply bg-yellow-100 text-yellow-800;
        }
        .status-badge.approved {
            @apply bg-green-100 text-green-800;
        }
        .status-badge.rejected {
            @apply bg-red-100 text-red-800;
        }
        .btn {
            @apply px-4 py-2 rounded font-semibold transition-colors;
        }
        .btn.primary {
            @apply bg-blue-600 hover:bg-blue-700 text-white;
        }
        .btn.secondary {
            @apply bg-gray-200 hover:bg-gray-300 text-gray-700;
        }
        .btn.small {
            @apply px-3 py-1 text-sm;
        }
        .btn:disabled {
            @apply opacity-50 cursor-not-allowed hover:bg-gray-200;
        }
        .empty-state {
            @apply text-center py-8 text-gray-500;
        }
        .post-images-cell {
            @apply py-2;
        }
        .post-description {
            @apply max-w-xs truncate;
        }
        .actions {
            @apply py-2;
        }
        @keyframes shake {
            0%, 100% { transform: translateX(0); }
            25% { transform: translateX(-5px); }
            75% { transform: translateX(5px); }
        }
        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.7; }
        }
        .scanning-indicator {
            animation: pulse 2s infinite;
        }
    </style>
</head>

<body>
    <div id="app">
        <!-- QR Modal -->
        <qr-modal 
            v-if="showQrModal" 
            @credentials-loaded="handleCredentialsLoaded">
        </qr-modal>

        <!-- Main App -->
        <div v-if="!showQrModal" class="max-w-4xl mx-auto p-4">
            <!-- Header -->
            <header class="flex flex-col sm:flex-row items-center justify-between mb-6">
                <h1 class="text-3xl font-bold mb-2 sm:mb-0">Instagram Post Organizer</h1>
                <div class="flex gap-2">
                    <button @click="openModal" class="btn primary">Add New Post</button>
                    <button @click="exportPosts" class="btn secondary">Export Posts</button>
                    <button @click="$refs.importFile.click()" class="btn secondary">Import Posts</button>
                    <input 
                        ref="importFile" 
                        type="file" 
                        accept=".json" 
                        @change="importPosts" 
                        style="display: none">
                </div>
            </header>

            <!-- Posts Table -->
            <div class="overflow-x-auto bg-white rounded-lg shadow mb-8">
                <table class="min-w-full divide-y divide-gray-200">
                    <thead class="bg-gray-100">
                        <tr>
                            <th class="px-4 py-2 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">ID</th>
                            <th class="px-4 py-2 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Image</th>
                            <th class="px-4 py-2 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Post Description</th>
                            <th class="px-4 py-2 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Status</th>
                            <th class="px-4 py-2 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Actions</th>
                        </tr>
                    </thead>
                    <tbody class="bg-white divide-y divide-gray-200">
                        <!-- Empty State -->
                        <tr v-if="posts.length === 0">
                            <td colspan="5" class="empty-state">
                                <h3 class="text-lg font-semibold">No posts yet</h3>
                                <p>Click "Add New Post" to get started</p>
                            </td>
                        </tr>

                        <!-- Posts -->
                        <tr v-for="post in posts" :key="post.id">
                            <td class="px-4 py-2">{{ post.id }}</td>
                            <td class="px-4 py-2 post-images-cell">
                                <div v-if="post.images && post.images.length > 0" class="flex flex-wrap gap-1 items-center">
                                    <img 
                                        v-for="(image, index) in post.images.slice(0, 4)" 
                                        :key="index"
                                        :src="image" 
                                        :alt="`Image ${index + 1}`" 
                                        class="w-16 h-16 object-cover rounded border border-gray-200">
                                    <div v-if="post.images.length > 4" class="ml-2 text-xs text-gray-500 font-semibold">
                                        +{{ post.images.length - 4 }} more
                                    </div>
                                </div>
                                <span v-else class="text-gray-400">No images</span>
                            </td>
                            <td class="px-4 py-2 post-description" :title="post.description">{{ post.description }}</td>
                            <td class="px-4 py-2">
                                <span :class="`status-badge ${post.status}`">{{ post.status }}</span>
                            </td>
                            <td class="px-4 py-2 actions">
                                <div class="flex gap-2">
                                    <button @click="editPost(post)" class="inline-flex items-center gap-1 px-3 py-1 rounded bg-blue-500 hover:bg-blue-600 text-white text-xs font-semibold shadow transition" title="Edit">
                                        <svg xmlns='http://www.w3.org/2000/svg' class='h-4 w-4' fill='none' viewBox='0 0 24 24' stroke='currentColor'><path stroke-linecap='round' stroke-linejoin='round' stroke-width='2' d='M15.232 5.232l3.536 3.536M9 13l6.536-6.536a2 2 0 112.828 2.828L11.828 15.828a2 2 0 01-2.828 0L5 11.828a2 2 0 010-2.828L9 13z' /></svg>
                                        Edit
                                    </button>
                                    <button @click="toggleStatus(post)" :class="post.status === 'approved' ? 'bg-yellow-400 hover:bg-yellow-500 text-gray-900' : 'bg-green-500 hover:bg-green-600 text-white'" class="inline-flex items-center gap-1 px-3 py-1 rounded text-xs font-semibold shadow transition" :title="post.status === 'approved' ? 'Unapprove' : 'Approve'">
                                        <svg v-if="post.status === 'approved'" xmlns='http://www.w3.org/2000/svg' class='h-4 w-4' fill='none' viewBox='0 0 24 24' stroke='currentColor'><path stroke-linecap='round' stroke-linejoin='round' stroke-width='2' d='M6 18L18 6M6 6l12 12' /></svg>
                                        <svg v-else xmlns='http://www.w3.org/2000/svg' class='h-4 w-4' fill='none' viewBox='0 0 24 24' stroke='currentColor'><path stroke-linecap='round' stroke-linejoin='round' stroke-width='2' d='M5 13l4 4L19 7' /></svg>
                                        {{ post.status === 'approved' ? 'Unapprove' : 'Approve' }}
                                    </button>
                                    <button @click="deletePost(post.id)" class="inline-flex items-center gap-1 px-3 py-1 rounded bg-red-500 hover:bg-red-600 text-white text-xs font-semibold shadow transition" title="Delete">
                                        <svg xmlns='http://www.w3.org/2000/svg' class='h-4 w-4' fill='none' viewBox='0 0 24 24' stroke='currentColor'><path stroke-linecap='round' stroke-linejoin='round' stroke-width='2' d='M6 18L18 6M6 6l12 12' /></svg>
                                        Delete
                                    </button>
                                </div>
                            </td>
                        </tr>

                        <!-- Pagination -->
                        <tr>
                            <td colspan="5" class="py-2 text-center">
                                <button @click="prevPage" :disabled="currentPage === 1" class="btn small">Prev</button>
                                <span class="mx-2">Page {{ currentPage }} of {{ maxPage }}</span>
                                <button @click="nextPage" :disabled="currentPage === maxPage" class="btn small">Next</button>
                            </td>
                        </tr>
                    </tbody>
                </table>
            </div>

            <!-- Post Modal -->
            <post-modal 
                v-if="showModal" 
                :post="editingPost" 
                @close="closeModal" 
                @save="handleSavePost">
            </post-modal>
        </div>
    </div>

    <script>
        const { createApp, ref, reactive, computed, onMounted, nextTick } = Vue;

        // QR Modal Component
        const QrModal = {
            emits: ['credentials-loaded'],
            setup(props, { emit }) {
                const errorMessage = ref('');
                const statusMessage = ref('');
                const statusType = ref('info');
                const isScanning = ref(false);
                
                let html5QrCode = null;
                let scanning = false;

                const showStatus = (message, type = 'info') => {
                    statusMessage.value = message;
                    statusType.value = type;
                };

                const hideStatus = () => {
                    statusMessage.value = '';
                    statusType.value = 'info';
                };

                const handleDecoded = (decodedText) => {
                    try {
                        const credsObj = JSON.parse(decodedText);
                        showStatus('✅ Credentials verified successfully!', 'success');
                        
                        setTimeout(() => {
                            localStorage.setItem('creds', JSON.stringify(credsObj));
                            emit('credentials-loaded', credsObj);
                        }, 800);
                    } catch (e) {
                        errorMessage.value = '❌ Invalid QR code: Please ensure it contains valid credential data.';
                        hideStatus();
                    }
                };

                const startWebcam = () => {
                    errorMessage.value = '';
                    hideStatus();
                    
                    const qrContainer = document.getElementById('qr-reader');
                    qrContainer.innerHTML = '';
                    showStatus('📷 Starting camera...', 'scanning');
                    
                    html5QrCode = new Html5Qrcode('qr-reader');
                    scanning = true;
                    
                    html5QrCode.start(
                        { facingMode: 'environment' },
                        { fps: 10, qrbox: { width: 240, height: 240 } },
                        (decodedText) => {
                            if (scanning) {
                                scanning = false;
                                html5QrCode.stop().then(() => html5QrCode.clear());
                                handleDecoded(decodedText);
                            }
                        },
                        (errorMessage) => {
                            // Ignore scan errors - they're expected during scanning
                        }
                    ).then(() => {
                        showStatus('🔍 Point camera at QR code', 'scanning');
                    }).catch((err) => {
                        errorMessage.value = '❌ Camera access denied or unavailable. Please check permissions.';
                        hideStatus();
                    });
                };

                const uploadImage = () => {
                    const fileInput = document.createElement('input');
                    fileInput.type = 'file';
                    fileInput.accept = 'image/*';
                    fileInput.style.display = 'none';
                    
                    fileInput.onchange = (e) => {
                        if (!e.target.files.length) return;
                        
                        const imageFile = e.target.files[0];
                        showStatus('🔍 Processing image...', 'scanning');
                        
                        if (html5QrCode) {
                            html5QrCode.clear();
                        } else {
                            html5QrCode = new Html5Qrcode('qr-reader');
                        }
                        
                        scanning = false;
                        html5QrCode.scanFile(imageFile, true)
                            .then(decodedText => {
                                handleDecoded(decodedText);
                            })
                            .catch(err => {
                                errorMessage.value = '❌ No QR code found in image. Please try a clearer image.';
                                hideStatus();
                            });
                    };
                    
                    document.body.appendChild(fileInput);
                    fileInput.click();
                    document.body.removeChild(fileInput);
                };

                return {
                    errorMessage,
                    statusMessage,
                    statusType,
                    isScanning,
                    startWebcam,
                    uploadImage
                };
            },
            template: `
                <div class="fixed inset-0 z-50 flex items-center justify-center bg-black bg-opacity-50" style="backdrop-filter: blur(8px);">
                    <div class="bg-white rounded-lg shadow-lg w-full max-w-lg p-6 relative" style="background: linear-gradient(135deg, #ffffff 0%, #f8fafc 100%);">
                        <h2 class="text-xl font-semibold mb-4 text-center">Scan QR Code for Credentials</h2>
                        <p class="text-gray-600 text-center mb-6">Use your camera or upload an image to authenticate</p>
                        
                        <div v-if="errorMessage" class="bg-red-50 border border-red-200 text-red-700 px-4 py-3 rounded mb-4">
                            {{ errorMessage }}
                        </div>
                        
                        <div id="qr-reader" class="mx-auto mb-6 w-70 h-70 border-3 border-gray-200 rounded-lg overflow-hidden bg-gray-50 flex items-center justify-center">
                            <div class="text-gray-400 text-center">
                                <div class="text-5xl mb-2">📷</div>
                                <div>Camera will appear here</div>
                            </div>
                        </div>
                        
                        <div v-if="statusMessage" :class="statusType === 'scanning' ? 'scanning-indicator bg-blue-50 text-blue-700' : 'bg-green-50 text-green-700'" class="text-center py-2 px-4 rounded mb-4">
                            {{ statusMessage }}
                        </div>
                        
                        <div class="flex gap-4 justify-center">
                            <button @click="startWebcam" class="bg-blue-600 hover:bg-blue-700 text-white px-6 py-2 rounded font-semibold">
                                📹 Scan with Camera
                            </button>
                            <button @click="uploadImage" class="bg-gray-200 hover:bg-gray-300 text-gray-700 px-6 py-2 rounded font-semibold">
                                📁 Upload Image
                            </button>
                        </div>
                    </div>
                </div>
            `
        };

        // Post Modal Component
        const PostModal = {
            props: ['post'],
            emits: ['close', 'save'],
            setup(props, { emit }) {
                const form = reactive({
                    id: null,
                    description: '',
                    status: 'pending',
                    images: []
                });

                const currentImages = ref([]);
                const isUploading = ref(false);

                // Initialize form when post prop changes
                const initForm = () => {
                    if (props.post) {
                        form.id = props.post.id;
                        form.description = props.post.description;
                        form.status = props.post.status;
                        currentImages.value = [...(props.post.images || [])];
                    } else {
                        form.id = null;
                        form.description = '';
                        form.status = 'pending';
                        currentImages.value = [];
                    }
                };

                // Initialize form on mount and when post changes
                onMounted(initForm);

                const getCreds = () => {
                    const credsStr = localStorage.getItem('creds');
                    if (!credsStr) throw new Error('Missing credentials');
                    return JSON.parse(credsStr);
                };

                const uploadToImgBB = async (file) => {
                    const creds = getCreds();
                    const apiKey = creds.imgbb.apiKey;
                    const formData = new FormData();
                    formData.append('key', apiKey);
                    formData.append('image', file);
                    
                    const response = await fetch('https://api.imgbb.com/1/upload', {
                        method: 'POST',
                        body: formData
                    });
                    
                    const data = await response.json();
                    if (data && data.success && data.data && data.data.url) {
                        return data.data.url;
                    } else {
                        throw new Error('ImgBB upload failed');
                    }
                };

                const handleImageUpload = async (event) => {
                    const files = Array.from(event.target.files);
                    isUploading.value = true;
                    
                    for (const file of files) {
                        if (file && file.type.startsWith('image/')) {
                            try {
                                // Add placeholder
                                currentImages.value.push({ uploading: true });
                                
                                const url = await uploadToImgBB(file);
                                
                                // Replace placeholder with actual URL
                                const idx = currentImages.value.findIndex(img => img.uploading);
                                if (idx !== -1) {
                                    currentImages.value[idx] = url;
                                }
                            } catch (err) {
                                alert('Failed to upload image to ImgBB.');
                                // Remove placeholder
                                const idx = currentImages.value.findIndex(img => img.uploading);
                                if (idx !== -1) {
                                    currentImages.value.splice(idx, 1);
                                }
                            }
                        }
                    }
                    
                    isUploading.value = false;
                    event.target.value = ''; // Reset input
                };

                const removeImage = (index) => {
                    currentImages.value.splice(index, 1);
                };

                const handleSubmit = () => {
                    if (!form.description.trim()) {
                        alert('Please enter a post description');
                        return;
                    }
                    
                    const postData = {
                        id: form.id,
                        description: form.description.trim(),
                        status: form.status,
                        images: currentImages.value.filter(img => typeof img === 'string')
                    };
                    
                    emit('save', postData);
                };

                const closeModal = () => {
                    emit('close');
                };

                // Watch for post prop changes
                const unwatchPost = Vue.watch(() => props.post, initForm, { immediate: true });

                return {
                    form,
                    currentImages,
                    isUploading,
                    handleImageUpload,
                    removeImage,
                    handleSubmit,
                    closeModal
                };
            },
            template: `
                <div class="fixed inset-0 z-50 flex items-center justify-center bg-black bg-opacity-50" @click.self="closeModal">
                    <div class="bg-white rounded-lg shadow-lg w-full max-w-lg p-6 relative">
                        <span @click="closeModal" class="absolute top-4 right-4 text-2xl text-gray-400 hover:text-gray-700 cursor-pointer">&times;</span>
                        <h2 class="text-xl font-semibold mb-4">{{ post ? 'Edit Post' : 'Add New Post' }}</h2>
                        
                        <form @submit.prevent="handleSubmit" class="space-y-4">
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-1">Post Images:</label>
                                <input 
                                    type="file" 
                                    accept="image/*" 
                                    multiple 
                                    @change="handleImageUpload"
                                    class="block w-full text-sm text-gray-500 file:mr-4 file:py-2 file:px-4 file:rounded file:border-0 file:text-sm file:font-semibold file:bg-blue-50 file:text-blue-700 hover:file:bg-blue-100">
                                
                                <div class="flex flex-wrap gap-2 mt-2">
                                    <div v-for="(image, index) in currentImages" :key="index" class="relative inline-block">
                                        <img v-if="typeof image === 'string'" :src="image" :alt="'Preview ' + (index + 1)" class="w-20 h-20 object-cover rounded border border-gray-200 shadow-sm">
                                        <div v-else-if="image.uploading" class="w-20 h-20 flex items-center justify-center bg-gray-100 text-gray-400 rounded border border-gray-200 text-xs">Uploading...</div>
                                        <button v-if="typeof image === 'string'" @click="removeImage(index)" type="button" class="absolute -top-2 -right-2 bg-red-500 text-white rounded-full w-6 h-6 flex items-center justify-center text-sm font-bold hover:bg-red-600">×</button>
                                    </div>
                                </div>
                            </div>
                            
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-1">Post Description:</label>
                                <textarea 
                                    v-model="form.description" 
                                    rows="4" 
                                    required 
                                    placeholder="Enter your Instagram post description..."
                                    class="block w-full border border-gray-300 rounded p-2 focus:ring-blue-500 focus:border-blue-500"></textarea>
                            </div>
                            
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-1">Status:</label>
                                <select v-model="form.status" class="block w-full border border-gray-300 rounded p-2 focus:ring-blue-500 focus:border-blue-500">
                                    <option value="pending">Pending</option>
                                    <option value="approved">Approved</option>
                                    <option value="rejected">Rejected</option>
                                </select>
                            </div>
                            
                            <div class="flex justify-end gap-2">
                                <button type="submit" :disabled="isUploading" class="bg-blue-600 hover:bg-blue-700 text-white font-semibold py-2 px-4 rounded shadow disabled:opacity-50">
                                    {{ isUploading ? 'Uploading...' : 'Save Post' }}
                                </button>
                                <button type="button" @click="closeModal" class="bg-gray-200 hover:bg-gray-300 text-gray-700 font-semibold py-2 px-4 rounded shadow">Cancel</button>
                            </div>
                        </form>
                    </div>
                </div>
            `
        };

        // Main App
        createApp({
            components: {
                QrModal,
                PostModal
            },
            setup() {
                const showQrModal = ref(!localStorage.getItem('creds'));
                const showModal = ref(false);
                const editingPost = ref(null);
                const posts = ref([]);
                const currentPage = ref(1);
                const pageSize = ref(10);
                const totalPosts = ref(0);
                const supabaseClient = ref(null);

                const maxPage = computed(() => Math.max(1, Math.ceil(totalPosts.value / pageSize.value)));

                const initSupabase = (creds) => {
                    const SUPABASE_URL = creds.supabase.url;
                    const SUPABASE_KEY = creds.supabase.key;
                    supabaseClient.value = window.supabase.createClient(SUPABASE_URL, SUPABASE_KEY);
                };

                const getCreds = () => {
                    const credsStr = localStorage.getItem('creds');
                    if (!credsStr) throw new Error('Missing credentials');
                    return JSON.parse(credsStr);
                };

                const loadPosts = async () => {
                    if (!supabaseClient.value) return;

                    // Get total count
                    const { count, error: countError } = await supabaseClient.value
                        .from('posts')
                        .select('*', { count: 'exact', head: true });
                    
                    if (!countError) {
                        totalPosts.value = count || 0;
                    }

                    // Get paginated posts
                    const from = (currentPage.value - 1) * pageSize.value;
                    const to = from + pageSize.value - 1;

                    const { data, error } = await supabaseClient.value
                        .from('posts')
                        .select('*')
                        .order('id', { ascending: true })
                        .range(from, to);

                    if (error) {
                        alert('Failed to load posts from Supabase.');
                        posts.value = [];
                    } else {
                        posts.value = data || [];
                    }
                };

                const handleCredentialsLoaded = (creds) => {
                    showQrModal.value = false;
                    initSupabase(creds);
                    loadPosts();
                };

                const openModal = (post = null) => {
                    editingPost.value = post;
                    showModal.value = true;
                };

                const closeModal = () => {
                    showModal.value = false;
                    editingPost.value = null;
                };

                const handleSavePost = async (postData) => {
                    if (!supabaseClient.value) return;

                    if (postData.id) {
                        // Update existing post
                        const { error } = await supabaseClient.value
                            .from('posts')
                            .update({
                                description: postData.description,
                                status: postData.status,
                                images: postData.images,
                                updated_at: new Date().toISOString()
                            })
                            .eq('id', postData.id);

                        if (error) {
                            alert('Failed to update post in Supabase.');
                            return;
                        }

                        // Update local post
                        const post = posts.value.find(p => p.id === postData.id);
                        if (post) {
                            Object.assign(post, postData, { updated_at: new Date().toISOString() });
                        }
                    } else {
                        // Create new post
                        const { data, error } = await supabaseClient.value
                            .from('posts')
                            .insert({
                                description: postData.description,
                                status: postData.status,
                                images: postData.images,
                                created_at: new Date().toISOString(),
                                updated_at: new Date().toISOString()
                            })
                            .select();

                        if (error) {
                            alert('Failed to add post to Supabase.');
                            return;
                        }

                        if (data && data[0]) {
                            posts.value.push(data[0]);
                            totalPosts.value++;
                        }
                    }

                    closeModal();
                };

                const editPost = (post) => {
                    openModal(post);
                };

                const deletePost = async (id) => {
                    if (!confirm('Are you sure you want to delete this post?')) return;
                    if (!supabaseClient.value) return;

                    const { error } = await supabaseClient.value
                        .from('posts')
                        .delete()
                        .eq('id', id);

                    if (error) {
                        alert('Failed to delete post from Supabase.');
                        return;
                    }

                    posts.value = posts.value.filter(post => post.id !== id);
                    totalPosts.value--;
                };

                const toggleStatus = async (post) => {
                    if (!supabaseClient.value) return;

                    const newStatus = post.status === 'approved' ? 'pending' : 'approved';

                    const { error } = await supabaseClient.value
                        .from('posts')
                        .update({
                            status: newStatus,
                            updated_at: new Date().toISOString()
                        })
                        .eq('id', post.id);

                    if (error) {
                        alert('Failed to update status in Supabase.');
                        return;
                    }

                    post.status = newStatus;
                    post.updated_at = new Date().toISOString();
                };

                const prevPage = () => {
                    if (currentPage.value > 1) {
                        currentPage.value--;
                        loadPosts();
                    }
                };

                const nextPage = () => {
                    if (currentPage.value < maxPage.value) {
                        currentPage.value++;
                        loadPosts();
                    }
                };

                const exportPosts = async () => {
                    if (!supabaseClient.value) return;

                    const { data, error } = await supabaseClient.value
                        .from('posts')
                        .select('*')
                        .order('id', { ascending: true });

                    if (error) {
                        alert('Failed to export posts from Supabase.');
                        return;
                    }

                    const dataStr = JSON.stringify(data, null, 2);
                    const dataBlob = new Blob([dataStr], { type: 'application/json' });
                    const url = URL.createObjectURL(dataBlob);
                    const link = document.createElement('a');
                    link.href = url;
                    link.download = 'instagram-posts.json';
                    link.click();
                    URL.revokeObjectURL(url);
                };

                const importPosts = async (event) => {
                    const file = event.target.files[0];
                    if (!file || !supabaseClient.value) return;

                    const reader = new FileReader();
                    reader.onload = async (e) => {
                        try {
                            const importedPosts = JSON.parse(e.target.result);
                            if (Array.isArray(importedPosts)) {
                                const cleanPosts = importedPosts.map(p => ({
                                    description: p.description,
                                    status: p.status,
                                    images: p.images || [],
                                    created_at: new Date().toISOString(),
                                    updated_at: new Date().toISOString()
                                }));

                                const { error } = await supabaseClient.value
                                    .from('posts')
                                    .insert(cleanPosts);

                                if (error) {
                                    alert('Failed to import posts to Supabase.');
                                    return;
                                }

                                await loadPosts();
                                alert('Posts imported successfully!');
                            }
                        } catch (error) {
                            alert('Error importing posts. Please check the file format.');
                        }
                    };
                    reader.readAsText(file);
                    event.target.value = ''; // Reset input
                };

                // Initialize app if credentials exist
                onMounted(() => {
                    if (!showQrModal.value) {
                        try {
                            const creds = getCreds();
                            initSupabase(creds);
                            loadPosts();
                        } catch (e) {
                            showQrModal.value = true;
                        }
                    }
                });

                // Keyboard shortcuts
                onMounted(() => {
                    const handleKeydown = (e) => {
                        if (e.ctrlKey && e.key === 'n') {
                            e.preventDefault();
                            openModal();
                        }
                        if (e.key === 'Escape') {
                            closeModal();
                        }
                    };

                    document.addEventListener('keydown', handleKeydown);

                    // Cleanup
                    return () => {
                        document.removeEventListener('keydown', handleKeydown);
                    };
                });

                return {
                    showQrModal,
                    showModal,
                    editingPost,
                    posts,
                    currentPage,
                    maxPage,
                    handleCredentialsLoaded,
                    openModal,
                    closeModal,
                    handleSavePost,
                    editPost,
                    deletePost,
                    toggleStatus,
                    prevPage,
                    nextPage,
                    exportPosts,
                    importPosts
                };
            }
        }).mount('#app');
    </script>
</body>

</html>